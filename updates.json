import requests
import json
import os
import sys

VERSION_FILE = "version.txt"
BANK_FILE = "bank_system.py"
UPDATE_URL = "https://raw.githubusercontent.com/WenJieTan/bank_system/main/updates.json"

def get_current_version():
    if not os.path.exists(VERSION_FILE):
        return "0.0.0"
    with open(VERSION_FILE, "r") as f:
        return f.read().strip()

def set_current_version(version):
    with open(VERSION_FILE, "w") as f:
        f.write(version)

def check_update():
    try:
        response = requests.get(UPDATE_URL, timeout=5)
        update_data = response.json()
    except Exception as e:
        print("检查更新失败:", e)
        return

    latest_version = update_data["1.0.1"]
    notes = update_data["修复了取款BUG，增加了转账功能"]
    new_code = update_data["print('欢迎使用银行系统 v1.0.0')\n\nbalance = 0\nwhile True:\n    print('\\n1. 存款\\n2. 取款\\n3. 查询余额\\n4. 退出')\n    choice = input('请选择操作: ')\n    if choice == '1':\n        amount = float(input('请输入存款金额: '))\n        balance += amount\n        print(f'存款成功，当前余额: {balance}')\n    elif choice == '2':\n        amount = float(input('请输入取款金额: '))\n        if amount <= balance:\n            balance -= amount\n            print(f'取款成功，当前余额: {balance}')\n        else:\n            print('余额不足！')\n    elif choice == '3':\n        print(f'当前余额: {balance}')\n    elif choice == '4':\n        print('谢谢使用，再见！')\n        break\n    else:\n        print('无效选择，请重新输入。')"]

    current_version = get_current_version()

    if latest_version != current_version:
        print(f"发现新版本 {latest_version}，更新内容：{notes}")
        with open(BANK_FILE, "w", encoding="utf-8") as f:
            f.write(new_code)
        set_current_version(latest_version)
        print("更新完成，请重新运行程序。")
        sys.exit()
    else:
        print(f"当前已是最新版本 {current_version}")

if __name__ == "__main__":
    check_update()
    if os.path.exists(BANK_FILE):
        os.system(f"python {BANK_FILE}")
    else:
        print("没有找到银行系统代码。")



